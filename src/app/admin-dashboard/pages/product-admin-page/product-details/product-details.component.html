
<form [formGroup]="productForm" (ngSubmit)="onSubmit()">

<!-- Barra sticky dentro del form -->
<div
  class="sticky top-0 z-40 bg-base-100/90 backdrop-blur border-b border-base-300
         px-4 lg:px-8 py-3">
  <div class="flex items-center gap-3">
    <h1 class="flex-1 text-2xl lg:text-3xl font-bold truncate">
      {{ product().title }}
    </h1>

    <button class="btn btn-primary btn-lg" type="submit">
      @if (isLoading()) {
        <span class="loading loading-spinner loading-sm"></span>
        Guardando...
      } @else {
        Guardar
      }
    </button>
  </div>
</div>

<div class="divider"></div>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-40">

  <!-- Datos generales -->
  <div class="flex flex-col">
    <h2 class="text-xl font-bold">Datos generales</h2>

    <div class="divider"></div>

    <div class="mb-5">
        <label class="label">
          <input type="checkbox" checked="checked" formControlName="novelty" class="toggle toggle-primary" />
          Es novedad
        </label>
    </div>


    <fieldset class="fieldset">
      <legend class="fieldset-legend">Título</legend>
      <input
        type="text"
        class="input input-bordered w-full"
        placeholder="Título"
        formControlName="title"
        [class.border-error]="formUtils.isValidField(productForm, 'title')"
         />
        <form-error-label [control]="productForm.get('title')!" fieldName="title" />
    </fieldset>

    <fieldset class="fieldset">
      <legend class="fieldset-legend">Código</legend>
      <input
        type="text"
        placeholder="Código"
        class="input input-bordered w-full"
        formControlName="cod"
        [class.border-error]="formUtils.isValidField(productForm, 'cod')"
      />
      <form-error-label [control]="productForm.get('cod')!" fieldName="cod" />
    </fieldset>

    <fieldset class="fieldset">
      <legend class="fieldset-legend">Slug</legend>
      <input
        type="text"
        placeholder="Slug"
        class="input input-bordered w-full"
        formControlName="slug"
        [class.border-error]="formUtils.isValidField(productForm, 'slug')"
      />
      <form-error-label [control]="productForm.get('slug')!" fieldName="slug" />
    </fieldset>


    <fieldset class="fieldset">
      <legend class="fieldset-legend">Descripción</legend>
      <textarea
        class="textarea textarea-bordered w-full"
        placeholder="Descripción"
        rows="6"
        formControlName="description"
        [class.border-error]="formUtils.isValidField(productForm, 'description')"
      ></textarea>
      <form-error-label [control]="productForm.get('description')!" fieldName="description" />
    </fieldset>

    <!-- tipos -->
    <fieldset class="fieldset">
      <legend class="fieldset-legend">Tipo de artículo</legend>
      <select class="select w-full" formControlName="type">
        <option [ngValue]="null">-- Seleccionar tipo --</option>
        @for (tipo of types; track tipo.id) {
          <option [value]="tipo.id">{{ tipo.name }}</option>
        }
      </select>
    </fieldset>
    <form-error-label [control]="productForm.get('type')!" fieldName="type" />

    <!-- Materiales -->
    <fieldset class="fieldset">
      <legend class="fieldset-legend">Material</legend>
      <select class="select w-full" formControlName="material">
        <option [ngValue]="null">-- Seleccionar material --</option>
        @for (material of materials; track material.id) {
          <option [value]="material.id">{{ material.name }}</option>
        }
      </select>
    </fieldset>
    <form-error-label [control]="productForm.get('material')!" fieldName="material" />

    <div class="divider"></div>


    <fieldset class="fieldset">
      <legend class="fieldset-legend">Tira de imágenes relacionadas</legend>
      <select class="select w-full" formControlName="related">
        <option value="">-- Sin grupo relacionado --</option>
        @for (rel of relatedGroups; track rel.key) {
          <option [value]="rel.image">{{ rel.key }}</option>
        }
      </select>
    </fieldset>

    <div class="divider"></div>

    <!-- Botones para las categorias -->
    <div class="flex gap-2">
      @for (cat of categories; track $index) {
        <button
          type="button"
          (click)="selectCategory(cat)"
          [class.btn-primary]="isCategorySelected(cat.slug)"
          class="btn btn-sm capitalize"
        >
          {{ cat.title }}
        </button>
      }
    </div>
    <form-error-label [control]="productForm.get('categories')!" fieldName="categories" />

  </div>

  <!-- Imágenes -->
  <div class="flex flex-col gap-2">
    <image-carousel [imagesCarousel]="product().images" />

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-4">
      @for (image of productForm.value.images; track $index) {
        <div class="relative group">
          <img [src]="image | pathImage:'productos'" alt="Imagen" class="w-full object-cover rounded-xl">
          <button type="button"
              (click)="removeExistingImage(image)"
              class="absolute top-1 right-1 btn btn-xs btn-error opacity-0 group-hover:opacity-100 transition-opacity">
            ✕
          </button>
        </div>
      }
    </div>

    <input
      type="file"
      multiple
      accept="image/*"
      class="file-input file-input-primary w-full mt-4"
      (change)="onFilesChanged($event)"
    />

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-4">
      @for (image of tempImages(); track $index) {
        <div class="relative group">
          <img [src]="image" alt="Imagen temporal" class="w-full object-cover rounded-xl">
          <button type="button"
                  (click)="removeTempImage($index)"
                  class="absolute top-1 right-1 btn btn-xs btn-error opacity-0 group-hover:opacity-100 transition-opacity">
            ✕
          </button>
        </div>
      }
    </div>

  </div>
  <!--Fin imagenes-->

</div>

</form>

@if (wasSaved()) {
  <div class="toast toast-top toast-center z-42">
    <div class="alert alert-success">
      <span>{{ successMessage() }}</span>
    </div>
  </div>
}
